<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>G·ª≠i Feedback</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- FONT -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBSkY9L3e6e4hmduWuP_SIJskDPEftzelQ",
            authDomain: "feedback-1310.firebaseapp.com",
            projectId: "feedback-1310",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- CODE M·ªöI: T·ª∞ ƒê·ªòNG ƒêI·ªÄN T√äN V√Ä L·ªöP T·ª™ URL ---
        window.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const nameParam = params.get("name");
            const classParam = params.get("class");

            const nameInput = document.getElementById("name");
            const classInput = document.getElementById("class");

            if (nameParam) {
                nameInput.value = nameParam;
                nameInput.setAttribute("readonly", true); // Kh√≥a kh√¥ng cho s·ª≠a
                nameInput.classList.add("locked"); // Th√™m class ƒë·ªÉ ƒë·ªïi m√†u n·ªÅn
            }

            if (classParam) {
                classInput.value = classParam;
                classInput.setAttribute("readonly", true); // Kh√≥a kh√¥ng cho s·ª≠a
                classInput.classList.add("locked");
            }
        });
        // ------------------------------------------------

        window.sendFeedback = async () => {
            const name = document.getElementById("name");
            const classInput = document.getElementById("class");
            const type = document.getElementById("type");
            const content = document.getElementById("content");

            let valid = true;
            [name, classInput, content].forEach(i => i.classList.remove("invalid", "valid"));

            if (name.value.trim().length < 2) { name.classList.add("invalid"); valid = false; } else name.classList.add("valid");
            // Cho ph√©p l·ªõp ch·ª©a ch·ªØ c√°i n·∫øu c·∫ßn (v√≠ d·ª• 12A3), ho·∫∑c gi·ªØ nguy√™n regex s·ªë n·∫øu ch·ªâ d√πng s·ªë
            if (classInput.value.trim().length < 1) { classInput.classList.add("invalid"); valid = false; } else classInput.classList.add("valid");
            if (content.value.trim().length < 5) { content.classList.add("invalid"); valid = false; } else content.classList.add("valid");

            if (!valid) return;

            // Hi·ªáu ·ª©ng loading n√∫t
            const btn = document.querySelector("button");
            const originalText = btn.innerText;
            btn.innerText = "ƒêang g·ª≠i...";
            btn.disabled = true;

            try {
                await addDoc(collection(db, "feedbacks"), {
                    name: name.value,
                    class: classInput.value,
                    type: type.value,
                    content: content.value,
                    createdAt: serverTimestamp()
                });
                showToast("G·ª≠i feedback th√†nh c√¥ng!!!", true);
                
                // Ch·ªâ x√≥a n·ªôi dung, gi·ªØ l·∫°i t√™n v√† l·ªõp
                content.value = "";
                content.classList.remove("valid");
            } catch (e) {
                console.error(e);
                showToast("C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i.", false);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        };

        window.showToast = (msg) => {
            const t = document.getElementById("toast");
            t.textContent = msg;
            t.classList.add("show");
            setTimeout(() => t.classList.remove("show"), 3000);
        };
    </script>

    <style>
        * { box-sizing: border-box }
        body { margin: 0; padding: 40px; background: transparent; font-family: 'Inter', sans-serif; display: flex; justify-content: center; }
        /* CARD */
        .card { width: 720px; background: white; padding: 36px; border-radius: 26px; box-shadow: 0 40px 80px rgba(0, 0, 0, .08), inset 0 1px 0 rgba(255, 255, 255, .6); }
        h2 { margin: 0 0 6px; text-align: center; }
        .subtitle { color: #6b7280; margin-bottom: 28px; text-align: center; }
        /* FORM */
        .group { margin-bottom: 18px; }
        label { font-size: 14px; font-weight: 500; margin-bottom: 6px; display: block; }
        input, textarea, select { width: 100%; padding: 14px 16px; border-radius: 14px; border: 2px solid #e5e7eb; font-size: 15px; outline: none; transition: .25s; background: #fafafa; }
        textarea { resize: none; height: 140px; }
        
        /* LOCKED STATE (Khi t·ª± ƒë·ªông ƒëi·ªÅn) */
        input.locked { background-color: #f3f4f6; color: #6b7280; cursor: not-allowed; border-color: #e5e7eb; }
        
        /* FOCUS */
        input:not(.locked):focus, textarea:focus, select:focus { border-color: #2563eb; background: white; }
        /* VALIDATION */
        input.valid, textarea.valid { border-color: #22c55e; background: #f0fdf4; }
        input.invalid, textarea.invalid { border-color: #ef4444; background: #fef2f2; }
        /* BUTTON */
        button { margin-top: 10px; width: 100%; padding: 15px; font-size: 16px; font-weight: 600; border: none; border-radius: 16px; background: linear-gradient(135deg, #2563eb, #3b82f6); color: white; cursor: pointer; transition: .25s; }
        button:hover { transform: translateY(-1px); box-shadow: 0 10px 30px rgba(37, 99, 235, .35); }
        button:disabled { opacity: 0.7; cursor: wait; transform: none; }
        /* TOAST */
        .toast { position: fixed; bottom: 30px; right: 30px; background: #22c55e; color: white; padding: 14px 22px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0, 0, 0, .2); opacity: 0; transform: translateY(10px); transition: .3s; }
        .toast.show { opacity: 1; transform: none; }
    </style>
</head>
<body>
    <div class="card">
        <h2>üì® G·ª≠i Feedback</h2>
        <div class="subtitle">√ù ki·∫øn c·ªßa b·∫°n gi√∫p h·ªá th·ªëng t·ªët h∆°n</div>
        <div class="group">
            <label>T√™n</label>
            <input id="name" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n">
        </div>
        <div class="group">
            <label>L·ªõp</label>
            <input id="class" placeholder="V√≠ d·ª•: 12A3">
        </div>
        <div class="group">
            <label>Lo·∫°i feedback</label>
            <select id="type">
                <option>G√≥p √Ω</option>
                <option>B√°o l·ªói</option>
                <option>ƒê·ªÅ xu·∫•t</option>
            </select>
        </div>
        <div class="group">
            <label>N·ªôi dung</label>
            <textarea id="content" placeholder="Nh·∫≠p n·ªôi dung feedback..."></textarea>
        </div>
        <button onclick="sendFeedback()">G·ª≠i feedback</button>
    </div>
    <div id="toast" class="toast"></div>
</body>
</html>
