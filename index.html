<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feedback Station - Cloud Storage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: {
                        primary: '#2563eb',
                        secondary: '#9333ea',
                        accent: '#f59e0b',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f8fafc;
            color: #1e293b;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.7); 
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.05);
        }

        .star {
            cursor: pointer; transition: transform 0.2s, color 0.2s;
            font-size: 2.5rem; color: #cbd5e1;
        }
        .star.active { 
            color: #f59e0b; 
            filter: drop-shadow(0 0 5px rgba(245, 158, 11, 0.5)); 
        }
        .star:hover { transform: scale(1.2); }
        
        /* Marquee Animation */
        .marquee-container {
            mask-image: linear-gradient(to bottom, transparent, black 10%, black 90%, transparent);
            -webkit-mask-image: linear-gradient(to bottom, transparent, black 10%, black 90%, transparent);
        }
        .marquee-content {
            /* T·∫°m t·∫Øt animation m·∫∑c ƒë·ªãnh ƒë·ªÉ JS x·ª≠ l√Ω scroll m∆∞·ª£t h∆°n khi c√≥ data m·ªõi, 
               ho·∫∑c c√≥ th·ªÉ b·∫≠t l·∫°i n·∫øu mu·ªën */
            animation: scrollUp 40s linear infinite; 
        }
        .marquee-content:hover { animation-play-state: paused; }
        
        @keyframes scrollUp {
            0% { transform: translateY(0); }
            100% { transform: translateY(-50%); }
        }

        .tech-input {
            background: #ffffff;
            border: 1px solid #cbd5e1;
            transition: all 0.3s;
            color: #334155;
        }
        .tech-input:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            outline: none;
        }
        .hidden-mode { display: none !important; }
        .full-width { grid-column: span 2 !important; }
        
        .btn-delete {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .review-card:hover .btn-delete {
            opacity: 1;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 bg-slate-50">

    <div id="mainContainer" class="w-full max-w-5xl grid grid-cols-1 md:grid-cols-2 gap-8 h-auto md:h-[600px] mb-10">
        
        <!-- C·ªòT TR√ÅI: FORM (G·ª¨I D·ªÆ LI·ªÜU) -->
        <div id="leftColumn" class="glass p-6 md:p-8 rounded-3xl flex flex-col justify-center relative overflow-hidden transition-all duration-500 order-1 bg-white">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 to-purple-500"></div>
            
            <div class="mb-6">
                <h2 class="text-3xl font-bold text-slate-800">G·ª¨I G√ìP √ù üì¨</h2>
                <p class="text-slate-500 text-sm mt-1">D·ªØ li·ªáu ƒë∆∞·ª£c l∆∞u tr·ªØ an to√†n tr√™n ƒë√°m m√¢y.</p>
            </div>
            
            <div id="emailAlert" class="hidden mb-4 bg-green-50 border border-green-200 p-3 rounded-xl flex items-center gap-3 shadow-sm">
                <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-green-600">üìß</div>
                <div class="text-sm text-green-700">
                    Ch√†o <b><span id="alertName">B·∫°n</span></b>, ƒë√£ nh·∫≠n <b><span id="alertStar">5</span> sao</b>.
                </div>
            </div>

            <form id="feedbackForm" class="space-y-5 relative z-10">
                <div>
                    <label class="block text-xs text-slate-500 font-bold mb-1 uppercase tracking-wider">Danh t√≠nh</label>
                    <input type="text" name="name" id="inpName" placeholder="VD: M√®o B√©o 12A3" required class="tech-input w-full rounded-xl p-3">
                </div>
                <div>
                    <label class="block text-xs text-slate-500 font-bold mb-1 uppercase tracking-wider text-center">M·ª©c ƒë·ªô h√†i l√≤ng</label>
                    <div class="flex justify-center gap-2 py-1" id="starContainer">
                        <span class="star text-3xl md:text-4xl" data-value="1">‚òÖ</span>
                        <span class="star text-3xl md:text-4xl" data-value="2">‚òÖ</span>
                        <span class="star text-3xl md:text-4xl" data-value="3">‚òÖ</span>
                        <span class="star text-3xl md:text-4xl" data-value="4">‚òÖ</span>
                        <span class="star text-3xl md:text-4xl" data-value="5">‚òÖ</span>
                    </div>
                    <input type="hidden" name="stars" id="ratingInput" value="5">
                </div>
                <div>
                    <label class="block text-xs text-slate-500 font-bold mb-1 uppercase tracking-wider">Th√¥ng ƒëi·ªáp</label>
                    <textarea name="message" id="inpMsg" rows="3" placeholder="G√≥p √Ω c·ªßa b·∫°n..." required class="tech-input w-full rounded-xl p-3"></textarea>
                </div>
                <button type="submit" id="submitBtn" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-500/30 transform active:scale-95 transition-all">
                    üöÄ G·ª¨I L√äN M√ÇY
                </button>
            </form>
            
            <div id="successMsg" class="hidden absolute inset-0 bg-white/95 backdrop-blur-sm flex-col items-center justify-center text-center z-20 rounded-3xl p-6">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mb-4 animate-bounce"><span class="text-4xl">üéâ</span></div>
                <h3 class="text-2xl font-bold text-slate-800">ƒê√É L∆ØU TH√ÄNH C√îNG!</h3>
                <p class="text-slate-500 mt-2 mb-8 max-w-xs mx-auto">Ph·∫£n h·ªìi ƒë√£ ƒë∆∞·ª£c l∆∞u vƒ©nh vi·ªÖn.</p>
                <button onclick="resetFormUI()" class="px-6 py-2.5 border border-slate-300 rounded-full hover:bg-slate-50 text-slate-600 transition font-medium text-sm">G·ª≠i ph·∫£n h·ªìi kh√°c</button>
            </div>
        </div>

        <!-- C·ªòT PH·∫¢I: T∆Ø·ªúNG REVIEW (L·∫§Y T·ª™ FIRESTORE) -->
        <div id="rightColumn" class="glass p-6 rounded-3xl flex flex-col h-[400px] md:h-full overflow-hidden transition-all duration-500 order-2 bg-white">
            <h3 class="text-xl font-bold mb-6 flex items-center gap-3 border-b border-slate-100 pb-4 text-slate-800">
                <span class="w-1.5 h-8 bg-yellow-400 rounded-full"></span>
                G√ìC FEEDBACK üíñ
            </h3>
            
            <div class="flex-1 overflow-hidden marquee-container relative">
                <div class="marquee-content space-y-4" id="reviewList">
                    <div class="text-center text-slate-400 py-10 loading-pulse">ƒêang k·∫øt n·ªëi d·ªØ li·ªáu ƒë√°m m√¢y...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 1. C·∫•u h√¨nh & Kh·ªüi t·∫°o
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        let currentUser = null;
        let isAdmin = false;

        // T√™n Collection (QUAN TR·ªåNG: D√πng ƒë∆∞·ªùng d·∫´n public ƒë·ªÉ m·ªçi ng∆∞·ªùi c√πng xem)
        // artifacts/{appId}/public/data/reviews
        const REVIEWS_COLLECTION = 'reviews'; 

        // 2. X·ª≠ l√Ω Authentication
        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("L·ªói ƒëƒÉng nh·∫≠p:", error);
                document.getElementById('reviewList').innerHTML = `<div class="text-red-500 text-center p-4">L·ªói k·∫øt n·ªëi Server. Vui l√≤ng t·∫£i l·∫°i trang.</div>`;
            }
        }

        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                // Sau khi c√≥ user, b·∫Øt ƒë·∫ßu l·∫Øng nghe d·ªØ li·ªáu
                listenToReviews();
            }
        });

        // 3. L·∫Øng nghe d·ªØ li·ªáu (Real-time)
        function listenToReviews() {
            if (!currentUser) return;

            const colRef = collection(db, 'artifacts', appId, 'public', 'data', REVIEWS_COLLECTION);
            
            // onSnapshot t·ª± ƒë·ªông ch·∫°y m·ªói khi d·ªØ li·ªáu thay ƒë·ªïi tr√™n server
            onSnapshot(colRef, (snapshot) => {
                const list = document.getElementById('reviewList');
                const rawData = [];

                snapshot.forEach(doc => {
                    rawData.push({ id: doc.id, ...doc.data() });
                });

                // S·∫Øp x·∫øp client-side (M·ªõi nh·∫•t l√™n ƒë·∫ßu)
                rawData.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));

                renderReviews(rawData);
            }, (error) => {
                console.error("L·ªói l·∫•y d·ªØ li·ªáu:", error);
            });
        }

        // 4. Render giao di·ªán
        function renderReviews(reviews) {
            const list = document.getElementById('reviewList');
            
            if (reviews.length === 0) {
                list.innerHTML = `<div class="text-center text-slate-400 py-10">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o.<br>H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n!</div>`;
                return;
            }

            // T·∫°o HTML chu·ªói
            // Nh√¢n ƒë√¥i danh s√°ch ƒë·ªÉ t·∫°o hi·ªáu ·ª©ng marquee m∆∞·ª£t m√† n·∫øu √≠t item (optional technique)
            // ·ªû ƒë√¢y ta render b√¨nh th∆∞·ªùng.
            
            let htmlContent = '';
            reviews.forEach(review => {
                let starsStr = "";
                const starCount = parseInt(review.stars) || 5;
                for(let s=0; s<starCount; s++) starsStr += "‚òÖ";

                // N√∫t x√≥a (Gi·∫£ l·∫≠p logic Admin c≈©)
                const deleteBtn = isAdmin ? 
                    `<button data-id="${review.id}" class="btn-delete-real absolute top-2 right-2 text-red-400 hover:text-red-600 bg-white rounded-full p-1 shadow-sm hover:shadow-md" title="X√≥a">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>` : '';

                htmlContent += `
                    <div class="review-card relative bg-white p-5 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition">
                        ${deleteBtn}
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-blue-600 truncate max-w-[80%]">${escapeHtml(review.name)}</span>
                            <div class="flex text-yellow-400 text-xs tracking-widest">${starsStr}</div>
                        </div>
                        <p class="text-slate-600 text-sm leading-relaxed break-words">"${escapeHtml(review.message)}"</p>
                        <p class="text-[10px] text-slate-300 mt-2 text-right">${new Date(review.createdAt).toLocaleDateString('vi-VN')}</p>
                    </div>`;
            });

            list.innerHTML = htmlContent;

            // G·∫Øn s·ª± ki·ªán x√≥a cho c√°c n√∫t v·ª´a t·∫°o
            if (isAdmin) {
                document.querySelectorAll('.btn-delete-real').forEach(btn => {
                    btn.addEventListener('click', (e) => handleDelete(e.currentTarget));
                });
            }
        }

        // 5. X·ª≠ l√Ω G·ª≠i Form
        const form = document.getElementById('feedbackForm');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentUser) {
                alert("ƒêang k·∫øt n·ªëi m√°y ch·ªß, vui l√≤ng ƒë·ª£i gi√¢y l√°t...");
                return;
            }

            const btn = document.getElementById('submitBtn');
            const originalText = btn.innerText;
            btn.innerHTML = 'üöÄ ƒêang l∆∞u...';
            btn.disabled = true;

            const name = document.getElementById('inpName').value;
            const message = document.getElementById('inpMsg').value;
            const stars = document.getElementById('ratingInput').value;

            try {
                // Th√™m v√†o Firestore
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', REVIEWS_COLLECTION), {
                    name: name,
                    message: message,
                    stars: stars,
                    createdAt: Date.now(),
                    uid: currentUser.uid // L∆∞u ID ng∆∞·ªùi g·ª≠i ƒë·ªÉ sau n√†y c√≥ th·ªÉ cho ph√©p h·ªç t·ª± x√≥a
                });

                // Hi·ªÉn th·ªã UI th√†nh c√¥ng
                document.getElementById('successMsg').classList.remove('hidden');
                document.getElementById('successMsg').classList.add('flex');

            } catch (error) {
                console.error("L·ªói khi l∆∞u:", error);
                alert("C√≥ l·ªói x·∫£y ra khi l∆∞u d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // 6. X·ª≠ l√Ω X√≥a (Gi·ªØ logic c≈©: h·ªèi m·∫≠t kh·∫©u)
        async function handleDelete(btnElement) {
            const docId = btnElement.getAttribute('data-id');
            const password = prompt("üîí Nh·∫≠p m·∫≠t kh·∫©u Admin ƒë·ªÉ x√≥a vƒ©nh vi·ªÖn:");
            // M·∫≠t kh·∫©u demo ƒë∆°n gi·∫£n client-side, th·ª±c t·∫ø n√™n x·ª≠ l√Ω server rules
            if (password !== "admin123") { 
                if(password) alert("Sai m·∫≠t kh·∫©u!");
                return;
            }

            const originalHtml = btnElement.innerHTML;
            btnElement.innerHTML = "‚è≥";
            
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', REVIEWS_COLLECTION, docId));
                // Kh√¥ng c·∫ßn l√†m g√¨ th√™m, onSnapshot s·∫Ω t·ª± c·∫≠p nh·∫≠t giao di·ªán
            } catch (error) {
                console.error("L·ªói x√≥a:", error);
                alert("Kh√¥ng th·ªÉ x√≥a: " + error.message);
                btnElement.innerHTML = originalHtml;
            }
        }

        // Helper: Escape HTML ƒë·ªÉ ch·ªëng XSS
        function escapeHtml(text) {
            if (!text) return "";
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Export ra window ƒë·ªÉ n√∫t Reset g·ªçi ƒë∆∞·ª£c
        window.resetFormUI = function() {
            document.getElementById('feedbackForm').reset();
            // Reset sao v·ªÅ 5
            document.getElementById('ratingInput').value = 5;
            updateStars(5);
            document.getElementById('successMsg').classList.add('hidden');
            document.getElementById('successMsg').classList.remove('flex');
        }

        // Logic c≈© cho UI (Sao, URL Params)
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            
            if (urlParams.get('admin') === '1') {
                isAdmin = true;
                document.body.style.borderTop = "4px solid red";
            }

            const viewMode = urlParams.get('view');
            if (viewMode === 'only') {
                document.getElementById('leftColumn').classList.add('hidden-mode');
                document.getElementById('rightColumn').classList.add('full-width');
                document.getElementById('mainContainer').classList.remove('md:grid-cols-2');
                document.getElementById('mainContainer').classList.add('grid-cols-1');
            }

            const paramName = urlParams.get('name');
            const paramStar = urlParams.get('star');

            if (paramName) {
                document.getElementById('inpName').value = decodeURIComponent(paramName);
                document.getElementById('alertName').innerText = decodeURIComponent(paramName);
            }
            if (paramStar) {
                document.getElementById('ratingInput').value = paramStar;
                updateStars(paramStar);
                document.getElementById('alertStar').innerText = paramStar;
                if (paramName) {
                    document.getElementById('emailAlert').classList.remove('hidden');
                }
            }
        };

        const stars = document.querySelectorAll('.star');
        const ratingInput = document.getElementById('ratingInput');
        
        function updateStars(val) {
            stars.forEach(s => {
                if(s.getAttribute('data-value') <= val) s.classList.add('active');
                else s.classList.remove('active');
            });
        }
        
        stars.forEach(star => {
            star.addEventListener('click', () => {
                const val = star.getAttribute('data-value');
                ratingInput.value = val;
                updateStars(val);
            });
        });
    </script>
</body>
</html>
